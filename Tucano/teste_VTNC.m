% tudo do zero
clear
clc

load('engine_data.mat')

%% escolha do motor

motor = buscam(sm,'Scorpion SII-3026-890KV');
kv = kv(motor)*2*pi/60;
r = r(motor);
i0 = i0(motor);
imax = imax(motor);

clear sm

%% Escolha da Hélice

J1 = [0.088	0.111	0.132	0.154	0.176	0.199	0.22	0.242	0.263	0.284	0.304	0.327	0.349	0.372	0.395	0.419	0.438];
J2 = [0.369	0.392	0.415	0.435	0.462	0.48	0.506	0.528	0.549	0.57	0.592	0.614	0.637];
J = [0.088	0.111	0.132	0.154	0.176	0.199	0.22	0.242	0.263	0.284	0.304	0.327	0.349   0.369	0.372   0.392	0.395   0.415	0.419   0.435	0.438   0.462	0.48	0.506	0.528	0.549	0.57	0.592	0.614	0.637];
Ct1 = [0.0859	0.0846	0.0832	0.0815	0.0797	0.0773	0.0747	0.0708	0.0668	0.0621	0.0574	0.052	0.0481	0.0433	0.0393	0.0354	0.032];
Ct2 = [0.0434	0.0395	0.0355	0.0323	0.0279	0.025	0.0209	0.0172	0.0136	0.01	0.006	0.0021	-0.002];
Ct = [0.0859	0.0846	0.0832	0.0815	0.0797	0.0773	0.0747	0.0708	0.0668	0.0621	0.0574	0.052	0.0481  0.0434	0.0433  0.0395	0.0393  0.0355	0.0354  0.0323	0.032   0.0279	0.025	0.0209	0.0172	0.0136	0.01	0.006	0.0021	-0.002];
Cp1 = [0.0333	0.0336	0.0338	0.0342	0.0345	0.0346	0.0346	0.0342	0.0335	0.0324	0.0311	0.0294	0.0282	0.0265	0.0251	0.0235	0.0222];
Cp2 = [0.0264	0.025	0.0235	0.0223	0.0204	0.0193	0.0176	0.016	0.0143	0.0125	0.0106	0.0086	0.0064];
Cp = [0.0333	0.0336	0.0338	0.0342	0.0345	0.0346	0.0346	0.0342	0.0335	0.0324	0.0311	0.0294	0.0282  0.0264	0.0265  0.025	0.0251  0.0235	0.0235  0.0223	0.0222  0.0204	0.0193	0.0176	0.016	0.0143	0.0125	0.0106	0.0086	0.0064];

[J_max,~] = max(J);
[J_min,~] = min(J);

pCt = polyfit(J,Ct,4);
pCp = polyfit(J,Cp,4);
pCq = pCp/(2*pi);

D = 11*0.0254;
prop_RPM = 6000;

%% Ecolha da velocidade e Voltage

V = 0:0.1:20;
v = 2.4:2.4:20;

%% Inicialização de parametros

[~,~,~,rho] = atmosisa(1000);
T = zeros(1,length(V));


for I_V = 1:length(V)
    nhz = V(I_V)/(J_max*D):0.01:V(I_V)/(J_min*D);
    RPM = nhz*60;
    ome = nhz*2*pi;
    J = V(I_V)./(nhz*D);
    Qp = rho.*nhz.^2*D^5.*polyval(pCp,J);
    Qm = ((v(6) - ome./kv)./r - i0)./kv;
    [M,I] = min(abs(Qm-Qp));
    M
    J1 = J(I);
    nhz1 = nhz(I);
    T(I_V) = rho*nhz1^2*D^4*polyval(pCt,J1)/9.81;
end

plot(V,T)
grid on
xlabel 'Velocidade [m/s]'
ylabel 'Tração [Kg]'
